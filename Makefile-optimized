# Cáº£i tiáº¿n Makefile Ä‘á»ƒ há»— trá»£ separate testing vÃ  building
# Makefile for TMS Project - Optimized cho workflow separation

.PHONY: help setup dev build up down logs clean restart status test coverage lint

# Default target
help:
	@echo "TMS Project - Development Commands"
	@echo "=================================="
	@echo "ğŸ—ï¸  Development Commands:"
	@echo "  setup       - Setup mÃ´i trÆ°á»ng development láº§n Ä‘áº§u"
	@echo "  dev         - Start development environment"
	@echo "  build       - Build táº¥t cáº£ Docker images"
	@echo "  build-be    - Build chá»‰ backend image"
	@echo "  build-fe    - Build chá»‰ frontend image"
	@echo "  up          - Start táº¥t cáº£ services"
	@echo "  down        - Stop táº¥t cáº£ services"
	@echo "  restart     - Restart táº¥t cáº£ services"
	@echo ""
	@echo "ğŸ§ª Testing Commands:"
	@echo "  test        - Cháº¡y tests cho cáº£ backend vÃ  frontend"
	@echo "  test-be     - Cháº¡y backend tests vá»›i coverage"
	@echo "  test-fe     - Cháº¡y frontend tests"
	@echo "  test-quick  - Cháº¡y quick tests (skip integration)"
	@echo "  coverage    - Xem coverage report"
	@echo ""
	@echo "ğŸ”§ Utility Commands:"
	@echo "  logs        - Xem logs cá»§a táº¥t cáº£ services"
	@echo "  logs-be     - Xem logs cá»§a backend"
	@echo "  logs-fe     - Xem logs cá»§a frontend"
	@echo "  status      - Kiá»ƒm tra tráº¡ng thÃ¡i services"
	@echo "  clean       - Dá»n dáº¹p containers vÃ  volumes"
	@echo "  lint        - Cháº¡y linting cho cáº£ backend vÃ  frontend"

# Setup mÃ´i trÆ°á»ng development láº§n Ä‘áº§u
setup:
	@echo "ğŸ—ï¸ Setting up TMS development environment..."
	@if [ ! -f .env ]; then \
		echo "ğŸ“ Creating .env from template..."; \
		cp .env.example .env; \
		echo "âš ï¸  Please edit .env file vá»›i thÃ´ng tin cá»§a báº¡n!"; \
	fi
	@echo "ğŸ”¨ Building images..."
	docker-compose build
	@echo "ğŸš€ Starting services..."
	docker-compose up -d
	@echo "âœ… Development environment setup complete!"
	@echo "Frontend: http://localhost:2025"
	@echo "Backend API: http://localhost:1990"
	@echo "pgAdmin: http://localhost:1999"

# Start development environment
dev: up

# Build táº¥t cáº£ images
build:
	@echo "ğŸ”¨ Building all Docker images..."
	docker-compose build

# Build chá»‰ backend image
build-be:
	@echo "ğŸ”¨ Building backend Docker image..."
	docker-compose build tms-server

# Build chá»‰ frontend image  
build-fe:
	@echo "ğŸ”¨ Building frontend Docker image..."
	docker-compose build tms-client

# Start services
up:
	@echo "ğŸš€ Starting TMS services..."
	docker-compose up -d
	@echo "âœ… Services started!"
	@echo "Frontend: http://localhost:2025"
	@echo "Backend API: http://localhost:1990"
	@echo "pgAdmin: http://localhost:1999"

# Stop services
down:
	@echo "ğŸ›‘ Stopping TMS services..."
	docker-compose down

# Xem logs táº¥t cáº£ services
logs:
	@echo "ğŸ“‹ Viewing all logs..."
	docker-compose logs -f

# Xem logs chá»‰ backend
logs-be:
	@echo "ğŸ“‹ Viewing backend logs..."
	docker-compose logs -f tms-server

# Xem logs chá»‰ frontend
logs-fe:
	@echo "ğŸ“‹ Viewing frontend logs..."
	docker-compose logs -f tms-client

# Restart services
restart:
	@echo "ğŸ”„ Restarting services..."
	docker-compose restart

# Restart chá»‰ backend
restart-be:
	@echo "ğŸ”„ Restarting backend..."
	docker-compose restart tms-server

# Restart chá»‰ frontend
restart-fe:
	@echo "ğŸ”„ Restarting frontend..."
	docker-compose restart tms-client

# Kiá»ƒm tra status
status:
	@echo "ğŸ“Š Service status:"
	docker-compose ps

# Dá»n dáº¹p
clean:
	@echo "ğŸ§¹ Cleaning up..."
	docker-compose down --volumes --remove-orphans
	docker system prune -f

# Cháº¡y tests cho cáº£ backend vÃ  frontend
test:
	@echo "ğŸ§ª Running all tests..."
	@echo "Backend tests (vá»›i H2 database):"
	cd tms-server && ./mvnw clean test -Dspring.profiles.active=test
	@echo "Frontend tests:"
	cd tms-client && npm test

# Cháº¡y quick tests (skip integration tests)
test-quick:
	@echo "ğŸ§ª Running quick tests..."
	@echo "Backend unit tests only:"
	cd tms-server && ./mvnw test -Dspring.profiles.active=test -Dtest="!**/*IntegrationTest"
	@echo "Frontend tests:"
	cd tms-client && npm test

# Cháº¡y backend tests vá»›i coverage report
test-be:
	@echo "ğŸ§ª Running backend tests vá»›i coverage..."
	cd tms-server && ./mvnw clean verify -Dspring.profiles.active=test
	@echo "âœ… Coverage report generated: tms-server/target/site/jacoco/index.html"

# Cháº¡y frontend tests
test-fe:
	@echo "ğŸ§ª Running frontend tests..."
	cd tms-client && npm test

# Xem coverage report
coverage:
	@echo "ğŸ“Š Opening coverage report..."
	@if [ -f tms-server/target/site/jacoco/index.html ]; then \
		open tms-server/target/site/jacoco/index.html; \
	else \
		echo "âš ï¸  Coverage report not found. Run 'make test-be' first!"; \
	fi

# Cháº¡y linting
lint:
	@echo "ğŸ” Running linting..."
	@echo "Backend linting (checkstyle):"
	cd tms-server && ./mvnw checkstyle:check
	@echo "Frontend linting:"
	cd tms-client && npm run lint

# Cháº¡y linting chá»‰ backend
lint-be:
	@echo "ğŸ” Running backend linting..."
	cd tms-server && ./mvnw checkstyle:check

# Cháº¡y linting chá»‰ frontend
lint-fe:
	@echo "ğŸ” Running frontend linting..."
	cd tms-client && npm run lint

# Build chá»‰ backend Ä‘á»ƒ test nhanh
build-server:
	@echo "ğŸ”¨ Building server only..."
	cd tms-server && ./mvnw clean package -DskipTests

# Test database connection
test-db:
	@echo "ğŸ” Testing database connection..."
	docker-compose exec tms-db pg_isready -U tms_user -d tms_db || echo "âš ï¸  Database not ready or not running"

# Development helpers
dev-be:
	@echo "ğŸš€ Starting development backend only..."
	docker-compose up -d tms-db pgadmin
	@echo "âœ… Database vÃ  pgAdmin started. Backend cÃ³ thá»ƒ run locally."

dev-fe:
	@echo "ğŸš€ Starting development frontend only..."
	cd tms-client && npm run dev
